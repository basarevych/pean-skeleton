/* pean-skeleton - v0.0.0 - 2015-07-31 */

"use strict";var app=angular.module("app",["ngResource","ngCookies","angular-loading-bar","globalizeWrapper","ui.router","ui.bootstrap","api","services","directives","filters","forms","state.layout","state.index"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("layout",{"abstract":!0,controller:"LayoutCtrl",templateUrl:"views/layout.html"}).state("layout.index",{url:"/",title:"APP_TITLE",controller:"IndexCtrl",templateUrl:"views/index.html"}),b.otherwise("/")}]),app.config(["globalizeWrapperProvider",function(a){a.setCldrBasePath("cldr"),a.setL10nBasePath("l10n")}]),app.run(["$rootScope","$state","$stateParams","$filter","$timeout","AppControl","LoginForm",function(a,b,c,d,e,f,g){a.pageTitle="Loading...",a.$state=b,a.$stateParams=c,a.appControl=f,a.login=function(){g().then(function(a){f.setToken(a.token),e(function(){f.loadProfile(!0)},101)})},a.$on("$stateChangeSuccess",function(b,c){a.pageTitle=d("glMessage")(c.title)}),f.init()}]);var api=angular.module("api",[]);api.factory("ResourceWrapper",["$rootScope","$q","$window","InfoDialog",function(a,b,c,d){return function(e,f){var g=b.defer();return e.then(function(a){g.resolve(a)})["catch"](function(b){return g.reject({error:"http",code:b.status}),f!==!0?401==b.status?(a.appControl.hasToken()&&a.appControl.removeToken(),void c.location.reload()):403==b.status?void d({title:"ERROR_API_DENIED_TITLE",text:"ERROR_API_DENIED_TEXT"}):void d({title:"ERROR_API_GENERIC_TITLE",text:"ERROR_API_GENERIC_TEXT"}):void 0}),g.promise}}]),api.factory("ProfileApi",["$resource","$window","ResourceWrapper",function(a,b,c){var d=a(b.config.apiUrl+"/profile/:action",{},{readList:{method:"GET",isArray:!1},updateList:{method:"PUT",isArray:!1},validate:{method:"POST",params:{action:"validate"},isArray:!1}});return{readList:function(a,b){return c(d.readList(a).$promise,b)},updateList:function(a,b){return c(d.updateList(a).$promise,b)},validate:function(a,b){return c(d.validate(a).$promise,b)}}}]),api.factory("AuthApi",["$resource","$window","ResourceWrapper",function(a,b,c){var d=a(b.config.apiUrl+"/auth/:action",{},{token:{method:"POST",params:{action:"token"},isArray:!1},validate:{method:"POST",params:{action:"validate"},isArray:!1}});return{token:function(a,b){return c(d.token(a).$promise,b)},validate:function(a,b){return c(d.validate(a).$promise,b)}}}]);var directives=angular.module("directives",[]);directives.directive("aclSref",["AppControl",function(a){return{link:function(b,c,d){var e=d.aclSref.split(" "),f=function(){var b=!1;angular.forEach(e,function(c){a.isAllowed(c)&&(b=!0)}),b?c.show():c.hide()};f()}}}]),directives.directive("onKeyEnter",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keypress",function(b){13===b.keyCode&&(b.preventDefault(),a.$apply(function(){a.$eval(c.onKeyEnter)}))})}}}]),directives.directive("focusOn",["$parse","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){var f=a(e.focusOn);c.$watch(f,function(a){a===!0&&b(function(){d.focus(),c.$apply(f.assign(c,!1))})})}}}]),directives.directive("sidebar",[function(){return{link:function(a,b,c){var d=$(window),e=c.sidebar,f=["xs","sm","md","lg"],g=function(){b.css({position:"fixed"});var a=b.position().top+b.outerHeight(!0),c=d.height()<a?"static":void 0;if(angular.isUndefined(c)){var g,h=$("<div>");h.appendTo($("body"));for(var i=f.length-1;i>=0;i--)if(h.addClass("hidden-"+f[i]),h.is(":hidden")){g=f[i];break}h.remove(),angular.isDefined(g)&&(c=f.indexOf(e)>f.indexOf(g)?"static":"fixed")}angular.isDefined(c)&&b.css({position:c}),b.css({width:b.parent().width()})};d.bind("resize",g),g()}}}]);var filters=angular.module("filters",[]),forms=angular.module("forms",[]);forms.factory("InfoDialog",["$modal","globalizeWrapper",function(a,b){var c=!1,d=function(a,b,c,d,e,f){a.title=c,a.text=d,a.yes=e,a.variables=f};return function(e){if(c)return null;c=!0;var f=a.open({controller:d,templateUrl:"modals/info-dialog.html",resolve:{title:function(){return e.title},text:function(){return angular.isArray(e.text)?e.text:[e.text]},yes:function(){return angular.isDefined(e.yes)?e.yes:""},variables:function(){return angular.isDefined(e.variables)?e.variables:{}},globalizeReady:null!=b.getLocale()}});return f.result["finally"](function(){c=!1}),f}}]),forms.factory("ModalFormCtrl",["$timeout","$filter",function(a,b){return function(c,d,e,f,g,h){c.model={},c.validation={errors:[],fields:{}},c.processing=!1,$.each(e,function(a,b){c.model[b.name]=b});var i=function(){var a=!1;$.each(c.model,function(b,d){var e=c.validation.fields[b];return angular.isDefined(e)&&e.length?(c.model[b].focus=!0,a=!0,!1):void 0}),a||$.each(c.model,function(a,b){return c.model[a].focus=!0,!1})},j=function(a){var d=!1;return $.each(c.model,function(e,f){(angular.isUndefined(a)||e==a)&&f.required&&0==f.value.toString().trim().length&&(d=!0,c.setValidationError(e,b("glMessage")("VALIDATOR_REQUIRED_FIELD")))}),!d},k=function(a){if(!c.processing&&j(a)&&(!angular.isDefined(f)||f(c,"validation"))&&!angular.isUndefined(g)){var b={field:a,form:{}};$.each(c.model,function(a,c){c.local||(b.form[c.name]=c.value)}),g(b).then(function(b){b.valid||$.each(b.errors,function(b,d){c.setValidationError(a,d)})})}};c.resetValidation=function(a){angular.isDefined(a)?c.validation.fields[a]=void 0:(c.validation.errors=[],c.validation.fields={})},c.setValidationError=function(a,b){angular.isUndefined(c.validation.fields[a])&&(c.validation.fields[a]=[]),-1==$.inArray(b,c.validation.fields[a])&&c.validation.fields[a].push(b)},c.validate=function(b){a(function(){k(b)},500)},c.submit=function(){if(c.resetValidation(),c.processing=!0,!j())return c.processing=!1,void i();if(angular.isDefined(f)&&!f(c,"submission"))return c.processing=!1,void i();if(angular.isUndefined(h))return void(c.processing=!1);var a={};$.each(c.model,function(b,c){c.local||(a[c.name]=c.value)}),h(a).then(function(a){return a.valid?void c.$close(a):(c.validation.errors=a.errors,c.validation.fields=a.fields,void i())})["finally"](function(){c.processing=!1})}}}]),forms.factory("LoginForm",["$modal","$filter","ModalFormCtrl","AuthApi",function(a,b,c,d){return function(){return a.open({controller:c,templateUrl:"modals/login.html",resolve:{fields:function(){return[{name:"login",required:!0,value:"",local:!1,focus:!0},{name:"password",required:!0,value:"",local:!1,focus:!1}]},parser:function(){return void 0},validator:function(){return d.validate},submitter:function(){return d.token}}}).result}}]),forms.factory("PasswordForm",["$modal","$filter","ModalFormCtrl","ProfileApi",function(a,b,c,d){return function(){function e(a,c){var d=!1,e=a.model.newPassword.value,f=a.model.retypedPassword.value;return("validation"==c&&f.length||"submission"==c&&(e.length||f.length))&&e.trim()!=f.trim()&&(d=!0,a.setValidationError("retypedPassword",b("glMessage")("VALIDATOR_INPUT_MISMATCH"))),!d}return a.open({controller:c,templateUrl:"modals/password.html",resolve:{fields:function(){return[{name:"currentPassword",required:!0,value:"",local:!1,focus:!0},{name:"newPassword",required:!0,value:"",local:!1,focus:!1},{name:"retypedPassword",required:!0,value:"",local:!0,focus:!1}]},parser:function(){return e},validator:function(){return d.validate},submitter:function(){return d.updateList}}}).result}}]);var services=angular.module("services",[]);services.factory("AppControl",["$window","$rootScope","$state","$stateParams","$timeout","$http","$cookies","globalizeWrapper","ProfileApi",function(a,b,c,d,e,f,g,h,i){function j(){if(!o&&q&&r){o=!0,b.$broadcast("AppInitialized");var a=null;if(null===p)c.current.name.length&&(a=function(){c.go(c.current.name,d,{reload:!0})});else{var f=p;p=null,a=function(){c.go(f.name,f.params,{reload:!0})}}null!==a&&e(a)}}var k=null,l=null,m="Token-"+a.config.apiUrl,n={locale:{current:null,fallback:null,available:[]},login:"anonymous",roles:[]},o=!1,p=null,q=!1,r=!1;return b.$on("GlobalizeLoadSuccess",function(){r=!0,j()}),b.$on("$stateChangeStart",function(a,b,c){o||(p={name:b.name,params:c},a.preventDefault())}),{isError:function(){return null!==k},setError:function(a){k=a},getError:function(){return k},isReady:function(){return o},hasToken:function(){return null!==l},setToken:function(b){l=b,localStorage.setItem(m,l),f.defaults.headers.common.Authorization="Bearer "+l,$.ajaxSetup({headers:{Authorization:"Bearer "+l},error:function(b){401==b.status&&(localStorage.removeItem(m),a.location.reload())}})},removeToken:function(){l=null,localStorage.removeItem(m),f.defaults.headers.common.Authorization=void 0,$.ajaxSetup({headers:{Authorization:void 0},error:void 0})},isAllowed:function(a){var b=c.get(a);if(!b)return!1;if(angular.isUndefined(b.roles))return!0;var d=!1;return $.each(this.getProfile().roles,function(a,c){-1!==b.roles.indexOf(c)&&(d=!0)}),d},aclCheckCurrentState:function(){var a=c.current.name;return this.isAllowed(a)?("ACL"==this.getError()&&this.setError(null),!0):(this.setError("ACL"),!1)},getProfile:function(){return n},loadProfile:function(b){var c=g.get("locale");"undefined"==typeof c?f.defaults.headers.common["Accept-Language"]=void 0:f.defaults.headers.common["Accept-Language"]=c.replace("_","-"),i.readList({}).then(function(c){q=!0,angular.equals(n,c)||(n=c,h.setLocale(n.locale.current.substr(0,2))),b===!0?a.location.reload():"function"==typeof b&&b()})},init:function(){if("undefined"==typeof a.config)return void this.setError("CONFIG");var b=localStorage.getItem(m);null!==b&&this.setToken(b),this.loadProfile(j)}}}]);var module=angular.module("state.index",[]);module.controller("IndexCtrl",["$scope",function(a){!a.appControl.aclCheckCurrentState()}]);var module=angular.module("state.layout",[]);module.controller("LayoutCtrl",["$scope","$cookies","$timeout","PasswordForm",function(a,b,c,d){a.locale=a.appControl.getProfile().locale,a.locale.cookie=b.get("locale"),a.setLocale=function(d){null===d?b.remove("locale"):b.put("locale",d),c(function(){a.appControl.loadProfile(!0)},101)},a.changePassword=function(){d()},a.logout=function(){a.appControl.removeToken(),c(function(){a.appControl.loadProfile(!0)},101)}}]);